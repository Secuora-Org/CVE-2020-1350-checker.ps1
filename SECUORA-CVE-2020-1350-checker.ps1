<#
.SYNOPSIS
    Comprueba si su servidor DNS es vulnerable a la ejecución remota de código.
.DESCRIPTION
   Script para comprobar si la vulneravilidad relacionada con CVE-2020-1350  es aplicable a su Windows Server.
.EXAMPLE
    PS C:\> .\SECUORA-CVE-2020-1350-checker.ps1
#>

If (-NOT ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    $arguments = "& '" + $myinvocation.mycommand.definition + "'"
    Start-Process powershell -Verb runAs -ArgumentList $arguments
    Break
}

function CheckForDNSServer {
    Write-Host "[*] Checking for the Windows DNS Service..."
    $DNSService = Get-Service | where-object { $_.name -like "DNS" } -ErrorAction SilentlyContinue
    if ($DNSService.Status -eq "Running") {
        Write-Host "[+] This server is acting as an Windows DNS Server. CVE-2020-1350 is applicable to this Windows Server." -ForegroundColor Green
    }
    Else {
        Write-Host "[+] This server is not acting as an Windows DNS Server. CVE-2020-1350 is not applicable to this Windows Server." -ForegroundColor Green
        Pause
        break
    }
}# End CheckForDNSServer function
function CheckIfUpdateIsInstalled {


    Write-Host "[*] Checking Windows Version..."
    $OSVersion = (Get-Itemproperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion" -Name ProductName).ProductName

    if (($OSVersion -eq "Windows Server 2012 Standard") -or ($OSVersion -eq "Windows Server 2012 Datacenter")) {
        Write-Host "[*] Windows Server 2012 detected..."
        Write-Host "[*] Check if security update or monthley rollup is installed..."
        $monthley_W2K2 = Get-HotFix -Id KB4565537 -ErrorAction SilentlyContinue
        $security_W2K2 = Get-HotFix -Id KB4565535 -ErrorAction SilentlyContinue

        if ($monthley_W2K2) {
            Write-Host "[*] *** Windows Update $($monthley_W2K2.HotFixID) is installed on $($monthley_W2K2.InstalledOn). You're not vulnerable ***"
            Write-Host "[+] No changes needed."
            break
        }
        elseif ($security_W2K2) {
            Write-Host "[*] *** Windows Update $($security_W2K2.HotFixID) is installed on $($security_W2K2.InstalledOn). You're not vulnerable ***"
            Write-Host "[+] No changes needed."
            break
        }
    }
    elseif ($OSVersion -like "Windows Server 2012 R2*") {
        "[*] Windows Server 2012 R2 detected..."
        Write-Host "[*] Check if security update or monthley rollup is installed..."
        $monthley_W2K2R2 = Get-HotFix -Id KB4565541 -ErrorAction SilentlyContinue
        $security_W2K2R2 = Get-HotFix -Id KB4565540 -ErrorAction SilentlyContinue

        if ($monthley_W2K2R2) {
            Write-Host "[*] *** Windows Update $($monthley_W2K2R2.HotFixID) is installed on $($monthley_W2K2R2.InstalledOn). You're not vulnerable ***"
            Write-Host "[+] No changes needed."
            break
        }
        elseif ($security_W2K2R2) {
            Write-Host "[*] *** Windows Update $($security_W2K2R2.HotFixID) is installed on $($security_W2K2R2.InstalledOn). You're not vulnerable ***"
            Write-Host "[+] No changes needed."
            break
        }
    }
    elseif ($OSVersion -like "Windows Server 2016*") {
        "[*] Windows Server 2016 detected..."
        Write-Host "[*] Check if security update or monthley rollup is installed..."
        $security_W2K16 = Get-HotFix -Id KB4565511 -ErrorAction SilentlyContinue

        if ($security_W2K16) {
            Write-Host "[*] *** Windows Update $($security_W2K16.HotFixID) is installed on $($security_W2K16.InstalledOn). You're not vulnerable ***"
            Write-Host "[+] No changes needed."
            break
        }
        elseif ($OSVersion -like "Windows Server 2019*") {
            "[+] Windows Server 2019 detected..."
            Write-Host "[*] Check if security update or monthley rollup is installed..."
            $security_W2K16 = Get-HotFix -Id KB4558998 -ErrorAction SilentlyContinue

            if ($security_W2K16) {
                Write-Host "[*] *** Windows Update $($security_W2K16.HotFixID) is installed on $($security_W2K16.InstalledOn). You're not vulnerable ***"
                Write-Host "[+] No changes needed."
                break
            }
        }
        Else {
            Write-Host "[-] Windows Update $($kb) is not installed."
        }
    }
} # End function CheckIfUpdateIsInstalled

function Get-Menu {
    param (
        [string]$title = "Workaround for CVE-2020-1350"
    )
    Write-Host ""
    Write-Host "================ $title ================"
    Write-Host ""

    Write-Host "1: Press '1' for check if this service is vulnerable for CVE-2020-1350"
    Write-Host "2: Press '2' to apply the CVE-2020-1350 workaround to this server (WARNING: The Windows DNS Service will be restarted!)"
    Write-Host "Q: Press 'Q' to quit."
} # End function Get-Menu


function Get-RegistryValue {
    param
    (
        [Parameter(Mandatory = $true)]
        $RegistryKey
    )

    $key = Get-Item -Path "Registry::$RegistryKey"
    $key.GetValueNames() |
    ForEach-Object {
        $name = $_
        $rv = 1 | Select-Object -Property Name, Type, Value
        $rv.Name = $name
        $rv.Type = $key.GetValueKind($name)
        $rv.Value = $key.GetValue($name)
        $rv

    }
} # End function Get-RegistryValue

function CheckRegDNS {
    param (
        [string]$reg = "HKLM:\SYSTEM\CurrentControlSet\Services\DNS\Parameters\"
    )
    $size = "0xFF00"
    $check = Get-ItemProperty -Path $reg -Name "TcpReceivePacketSize" -ErrorAction SilentlyContinue
    $check_dword = Get-RegistryValue "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\DNS\Parameters\" | Where-Object { $_.name -eq "TcpReceivePacketSize" } -ErrorAction SilentlyContinue


    if (($check.TcpReceivePacketSize -eq $size) -and ($check_dword.type -eq "DWORD")) {
        Write-Host "[+] TcpReceivePacketSize size is set to $($size) and is DWORD"
        Write-Host "[+] This Server is not vulnerable to CVE-2020-1350." -ForegroundColor Green
        break
    }
    elseif ($check.TcpReceivePacketSize -eq $null) {
        Write-Host "[+] TcpReceivePacketSize size entry no set"
        Write-Host "[-] This server is vulnerable to CVE-2020-1350." -f yellow
        Write-Host ""
        Write-Host "[*] To solve this issue you must apply one of the following fixes (ordered by preference)" -f Magenta
        Write-Host ""
        Write-Host "    > Update your Windows Server to the latest version" -f Magenta
        Write-Host "    > Update your Windows Server with the latest security patch" -f Magenta
        Write-Host "      link: https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1350" -f Magenta
        Write-Host "    > Apply the quick workaround by selecting the second menu option in this script" -f Magenta
        Write-Host ""
    }
    Else {
        Write-Host "[*] Workaround has not been applied. Please apply workaround (DNS Service is being restarted!) or install the Security Update."
        Write-Host "[-] This server is vulnerable to CVE-2020-1350." -f yellow
        Write-Host ""
        Write-Host "[*] To solve this issue you must apply one of the following fixes (ordered by preference)" -f Magenta
        Write-Host ""
        Write-Host "    > Update your Windows Server to the latest version" -f Magenta
        Write-Host "    > Update your Windows Server with the latest security patch" -f Magenta
        Write-Host "      link: https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1350" -f Magenta
        Write-Host "    > Apply the quick workaround by selecting the second menu option in this script" -f Magenta
        Write-Host ""
    }
} # End function CheckRegDNS

function SetDNSRegWorkaround {

    param (
    [string]$reg = "HKLM:\SYSTEM\CurrentControlSet\Services\DNS\Parameters\"
    )

    $size = "0xFF00"
    $check = Get-ItemProperty -Path $reg -Name "TcpReceivePacketSize" -ErrorAction SilentlyContinue
    $check_dword = Get-RegistryValue "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\DNS\Parameters\" | Where-Object { $_.name -eq "TcpReceivePacketSize" } -ErrorAction SilentlyContinue

    if (($check.TcpReceivePacketSize -eq $size) -and ($check_dword.type -eq "DWORD")) {
        Write-Host "[+] This Server is not vulnerable to CVE-2020-1350." -ForegroundColor Green
        break
    }
    Else {
        Write-Host "[*] Setting the workaround in the registry..."
        $reg = "HKLM:\SYSTEM\CurrentControlSet\Services\DNS\Parameters"
        $value = "0xFF00"

        try {
            Set-ItemProperty -Path $reg -name TcpReceivePacketSize -Type DWORD -value $value -Force
            Write-Host "[+] Setting the workaround registry entries...Done"
        }
        Catch {
            $err = $_.Exception.Message
            Write-Error $err
        }

        # Restarting DNS Service
        Write-Host "[*] Restarting Windows DNS Service..."
        try {
            restart-service DNS
            Write-Host "[+] DNS Service restarted"
        }
        Catch {
            $err = $_.Exception.Message
            Write-Error $err
        }
        CheckRegDNS
    }


} # End SetDNSRegWorkaround

Write-Host ""
Write-Host "  ___  ___  ___ _   _  ___  _ __ __ _ "
Write-Host " / __|/ _ \/ __| | | |/ _ \| '__/ _  |"
Write-Host " \__ \  __/ (__| |_| | (_) | | | (_| |"
Write-Host " |___/\___|\___|\__,_|\___/|_|  \__,_|"
Write-Host ""

CheckForDNSServer
CheckIfUpdateIsInstalled

Do {
    Get-Menu
    $HumanInput = Read-Host "Please make a selection"
    switch ($HumanInput) {
        '1' {
            Write-Host 'You chose option #1'
            CheckRegDNS
        } '2' {
            Write-Host 'You chose option #2'
            SetDNSRegWorkaround
        } 'Q' {
            return
        }
    }
    pause
}
until ($HumanInput -eq 'q')
